# Redis缓存穿透、缓存雪崩和缓存击穿

Redis缓存的使用，极大的提升了应用程序的性能和效率，特别是数据查询方面。但同时，它也带来了一些问题。其中，最要害的问题，就是数据的一致性问题，从严格意义上讲，这个问题无解。如果对数据的一致性要求很高，那么就不能使用缓存。        


## 缓存的使用流程
数据查询先进行缓存查询，如果key不存在或者key已经过期，再对数据库进行查询，并把查询到的对象放进缓存。如果数据库查询对象为空，则不放进缓存。


## 缓存穿透
缓存穿透，是指频繁查询一个在缓存和数据库中都不存在的数据。如果传入的key在数据库中不存在，那么每次都去查询数据库，而每次查询都是空，每次又都不会进行缓存。假如有恶意攻击，就可以利用这个漏洞，对数据库造成压力，甚至压垮数据库。即便是采用UUID，也是很容易找到一个不存在的KEY，进行攻击。

**解决方案：**
（1）对传入的key进行规则校验，例如key一定是九位数，那么就可以对不满足该条件的key进行拦截。
（2）缓存空值

代码流程：

1. 参数传入key
2. 根据key从缓存中获取value
3. 如果value不为空，直接返回
4. 如果value为空，进行数据库查询
5. 如果从数据库查询出的value不为空，则放入缓存
6. 如果从数据库中查询出的value为空，则在缓存中放入key-null，并设定过期时间（比如60秒），避免数据库被频繁查询。


## 缓存击穿

缓存击穿出现的场景是指一个key非常热点，被用户并发访问，缓存中不存在但数据库中存在这个key。这种情况一般出现在缓存时间到期，当这个key在失效的瞬间，持续的大并发就击穿缓存，直接请求数据库，就像在一个屏障上凿开了一个洞。

**解决方案：**
（1）设置热点数据永远不过期
（2）加互斥锁。


## 缓存雪崩
缓存雪崩，是指在较短时间段内，大量缓存数据集中过期，造成数据库压力过大的现象。
和缓存击穿不同的是，缓存击穿指并发查询同一条数据，缓存雪崩是大量的数据都过期了，很多数据都查不到从而查数据库，查询数据量巨大，引起数据库压力过大甚至宕机。

造成缓存雪崩的一种场景：双十一零点，很快就会迎来一波抢购，这波商品时间比较集中的放入了缓存，假设缓存一个小时。那么到了凌晨一点钟的时候，这批商品的缓存就都过期了。而对这批商品的访问查询，都落到了数据库上，对于数据库而言，就会产生周期性的压力波峰。

造成缓存雪崩的另一种场景：缓存服务器某个节点宕机或断网，这种情况对数据库服务器造成的压力是不可预知的，很有可能瞬间就把数据库压垮。

**解决方案：**
（1）缓存数据的过期时间设置随机，防止同一时间大量数据过期现象发生。
（2）如果缓存数据库是分布式部署，将热点数据均匀分布在不同的缓存数据库中。
（3）设置热点数据永远不过期。
